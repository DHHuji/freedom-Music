var MiniMasonry = (function () {
    "use strict";

    function MiniMasonry(options) {
        this._sizes = [];
        this._columns = [];
        this._container = null;
        this._count = null;
        this._width = 0;
        this._removeListener = null;
        this._currentGutterX = null;
        this._currentGutterY = null;
        this._resizeTimeout = null;

        this.conf = {
            baseWidth: 255,
            gutterX: null,
            gutterY: null,
            gutter: 10,
            container: null,
            minify: true,
            ultimateGutter: 5,
            surroundingGutter: true,
            direction: "ltr",
            wedge: false
        };

        this.init(options);
        return this;
    }

    MiniMasonry.prototype.init = function (options) {
        // Merge configuration options
        for (var key in this.conf) {
            if (options[key] != null) {
                this.conf[key] = options[key];
            }
        }

        // Set gutter values if not explicitly provided
        if (this.conf.gutterX != null && this.conf.gutterY != null) {
            // Both gutters are set, use them as is
        } else {
            this.conf.gutterX = this.conf.gutterY = this.conf.gutter;
        }

        this._currentGutterX = this.conf.gutterX;
        this._currentGutterY = this.conf.gutterY;

        // Get container element
        if (typeof this.conf.container === "object" && this.conf.container.nodeName) {
            this._container = this.conf.container;
        } else {
            this._container = document.querySelector(this.conf.container);
        }

        if (!this._container) {
            throw new Error("Container not found or missing");
        }

        // Set up resize listener
        var resizeHandler = this.resizeThrottler.bind(this);
        window.addEventListener("resize", resizeHandler);

        this._removeListener = function () {
            window.removeEventListener("resize", resizeHandler);
            if (this._resizeTimeout != null) {
                window.clearTimeout(this._resizeTimeout);
                this._resizeTimeout = null;
            }
        };

        this.layout();
    };

    MiniMasonry.prototype.reset = function () {
        this._sizes = [];
        this._columns = [];
        this._count = null;
        this._width = this._container.clientWidth;

        var baseWidth = this.conf.baseWidth;

        // Set minimum width if needed
        if (this._width < baseWidth) {
            this._width = baseWidth;
            this._container.style.minWidth = baseWidth + "px";
        }

        // Adjust gutter for single column layout
        if (this.getCount() == 1) {
            this._currentGutterX = this.conf.ultimateGutter;
            this._count = 1;
        } else if (this._width < this.conf.baseWidth + 2 * this._currentGutterX) {
            this._currentGutterX = 0;
        } else {
            this._currentGutterX = this.conf.gutterX;
        }
    };

    MiniMasonry.prototype.getCount = function () {
        if (this.conf.surroundingGutter) {
            return Math.floor(
                (this._width - this._currentGutterX) /
                (this.conf.baseWidth + this._currentGutterX)
            );
        } else {
            return Math.floor(
                (this._width + this._currentGutterX) /
                (this.conf.baseWidth + this._currentGutterX)
            );
        }
    };

    MiniMasonry.prototype.computeWidth = function () {
        var width;

        if (this.conf.surroundingGutter) {
            width = (this._width - this._currentGutterX) / this._count - this._currentGutterX;
        } else {
            width = (this._width + this._currentGutterX) / this._count - this._currentGutterX;
        }

        width = Number.parseFloat(width.toFixed(2));
        return width;
    };

    MiniMasonry.prototype.layout = function () {
        if (!this._container) {
            console.error("Container not found");
            return;
        }

        this.reset();

        if (this._count == null) {
            this._count = this.getCount();
        }

        var itemWidth = this.computeWidth();

        // Initialize columns
        for (var i = 0; i < this._count; i++) {
            this._columns[i] = 0;
        }

        var children = this._container.children;

        // Set width and store heights
        for (var i = 0; i < children.length; i++) {
            children[i].style.width = itemWidth + "px";
            this._sizes[i] = children[i].clientHeight;
        }

        // Calculate starting X position
        var startX, totalWidth;

        if (this.conf.direction == "ltr") {
            startX = this.conf.surroundingGutter ? this._currentGutterX : 0;
        } else {
            startX = this._width - (this.conf.surroundingGutter ? this._currentGutterX : 0);
        }

        // Adjust for centering when items don't fill width
        if (this._count > this._sizes.length) {
            totalWidth = this._sizes.length * (itemWidth + this._currentGutterX) - this._currentGutterX;

            if (this.conf.wedge === false) {
                if (this.conf.direction == "ltr") {
                    startX = (this._width - totalWidth) / 2;
                } else {
                    startX = this._width - (this._width - totalWidth) / 2;
                }
            } else {
                if (this.conf.direction != "ltr") {
                    startX = this._width - this._currentGutterX;
                }
            }
        }

        // Position each item
        for (var i = 0; i < children.length; i++) {
            var columnIndex = this.conf.minify ?
                this.getShortest() :
                this.getNextColumn(i);

            var gutterX = 0;

            if (!this.conf.surroundingGutter && columnIndex == this._columns.length) {
                // No additional gutter needed
            } else {
                gutterX = this._currentGutterX;
            }

            var x, y;

            if (this.conf.direction == "ltr") {
                x = startX + (itemWidth + gutterX) * columnIndex;
            } else {
                x = - (startX - (itemWidth + gutterX) * columnIndex - itemWidth);
            }

            y = this._columns[columnIndex];
            //console.log(this.conf.direction,'| startX:', startX, '| itemWidth:', itemWidth, '| gutterX:', gutterX, '| columnIndex:', columnIndex, '| x:', x, '| y:', y);

            children[i].style.transform = "translate3d(" +
                Math.round(x) + "px," +
                Math.round(y) + "px,0)";

            var gutterY = this._count > 1 ?
                this.conf.gutterY :
                this.conf.ultimateGutter;

            this._columns[columnIndex] += this._sizes[i] + gutterY;
        }

        // Set container height
        this._container.style.height =
            this._columns[this.getLongest()] - this._currentGutterY + "px";
    };

    MiniMasonry.prototype.getNextColumn = function (index) {
        return index % this._columns.length;
    };

    MiniMasonry.prototype.getShortest = function () {
        var shortestIndex = 0;

        for (var i = 0; i < this._count; i++) {
            if (this._columns[i] < this._columns[shortestIndex]) {
                shortestIndex = i;
            }
        }

        return shortestIndex;
    };

    MiniMasonry.prototype.getLongest = function () {
        var longestIndex = 0;

        for (var i = 0; i < this._count; i++) {
            if (this._columns[i] > this._columns[longestIndex]) {
                longestIndex = i;
            }
        }

        return longestIndex;
    };

    MiniMasonry.prototype.resizeThrottler = function () {
        if (!this._resizeTimeout) {
            this._resizeTimeout = setTimeout(function () {
                this._resizeTimeout = null;

                if (this._container.clientWidth != this._width) {
                    this.layout();
                }
            }.bind(this), 33);
        }
    };

    MiniMasonry.prototype.destroy = function () {
        // Remove event listener
        if (typeof this._removeListener === "function") {
            this._removeListener();
        }

        var children = this._container.children;

        // Remove inline styles from children
        for (var i = 0; i < children.length; i++) {
            children[i].style.removeProperty("width");
            children[i].style.removeProperty("transform");
        }

        // Remove container styles
        this._container.style.removeProperty("height");
        this._container.style.removeProperty("min-width");
    };

    return MiniMasonry;
})();